import{f as m,e as b}from"./scheduler.4b0cb93c.js";import{l as o}from"./index.4ee13bd9.js";import{w as p}from"./paths.b2d66cdf.js";function M(t){return(t==null?void 0:t.length)!==void 0?t:Array.from(t)}var j=t=>({tag:"left",left:t}),J=t=>({tag:"right",right:t}),c=t=>t.tag==="left",L=(t,e,r)=>{switch(t.tag){case"left":return e(t.left);case"right":return r(t.right)}},d=t=>typeof t!="function",N=t=>d(t)?t:t(),l=(t,e,r)=>({type:t,cause:e,stack:r}),u=t=>{const e=new Error(t.cause);return e.name=t.type,e.stack=t.stack,e},C=(t,e)=>{if(typeof t=="string")return l("unknown-error",t,e);const r=g(t);return l("unknown-error",r.message,r.message)},g=t=>t instanceof Error?t:new Error(`${t}`);function w(t=void 0){const{update:e,subscribe:r}=p({value:t,inc:0});return{set:n=>e(s=>({value:n,inc:s.inc+1})),update:n=>e(s=>({value:n(s.value),inc:s.inc+1})),subscribe:n=>r(s=>n(s.value))}}class v{constructor(e){this.writable=e}emit(e){return this.writable.set(e)}}class y{constructor(e){this.initialState=e,this.state=e,this.states=p(e),this.events=w(),this.emitter=new v(this.states),this.subscribe=this.states.subscribe}add(e){this.events.set(e)}on(e,r){this.events.subscribe(n=>{n&&r(n)&&e(n,s=>{this.state=s,this.emitter.emit(s)})})}reset(){this.state=this.initialState,this.emitter.emit(this.state)}}function f(t,e){return t.type===e}function O(t){return m(t)}function k(t){return b(t.constructor,t)}const h=(t,e)=>({type:"game-update",value:t,player:e});function A(){return{type:"new-game"}}function D(t){return{type:"join-game",code:t}}function S(t,e){return{type:"move",player:t,position:e}}const T=t=>f(t,"new-game"),E=t=>f(t,"join-game"),G=t=>f(t,"move");class W extends y{constructor(e){super(h({status:"not-started",id:"",players:[],state:[],nextMove:void 0},{id:"",name:"",type:"O"})),this.on(async(r,n)=>{const s=await e.start();if(c(s)){o(u(s.left)),n(this.state);return}const a=s.right,i=s.right.players[0];n(h(a,i)),this.subscribeToGameUpdates(e,n)},T),this.on(async(r,n)=>{this.state.value.id=r.code;const s=this.subscribeToGameUpdates(e,n),a=await e.join();if(c(a)){o(u(a.left)),n(this.state);return}s==null||s.right.subscribe(i=>{!i.players.includes(this.state.player)&&i.players.length===2&&n(h(i,i.players[1]))})},E),this.on(async(r,n)=>{const s=await e.move(r.player,r.position);if(c(s)){o(u(s.left)),n(this.state);return}},G)}subscribeToGameUpdates(e,r){const n=this.state.value,s=this.state.player,a=e.subscribe(n);if(c(a)){o(u(a.left)),r(this.state);return}return a.right.subscribe(i=>{i&&r(h(i,s))}),a}}export{D as J,j as L,S as M,A as N,J as R,W as T,C as U,y as a,N as c,M as e,L as f,k as p,O as r};
